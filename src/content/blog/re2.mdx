---
title: "Reverse åšé¢˜è®°å½• (2)"
description: "åšäº†ä¸¤é“ä¸»ç«™çš„é¢˜ TEAåŠ å¯† æ€è·¯æ¥è¿‘"
pubDate: "Apr 22 2025"
# image: /image/image3.png
categories:
  - tech
tags:
  - Reverse 
  - TEA
---
import Collapse from "../../components/mdx/Collapse.astro";
import Diff from "../../components/mdx/Diff.astro";
import Error from "../../components/mdx/Error.astro";
import Info from "../../components/mdx/Info.astro";
import Kbd from "../../components/mdx/Kbd.astro";
import Success from "../../components/mdx/Success.astro";
import Warning from "../../components/mdx/Warning.astro";
import TimeLine from "../../components/mdx/TimeLine.astro";
import LinkCard from "../../components/mdx/LinkCard.astro";

# ezMath

## é¢˜ç›®

[é¢˜ç›®é“¾æ¥](http://210.30.97.133:8000/challenges#ezMath-222)

SSSCTF ezMath 1

## è§£é¢˜

å¼€å±€ <Kbd>Shift </Kbd>+<Kbd>F12 </Kbd>ï¼Œæ‰¾åˆ°flagæ£€éªŒ

![1745324409179](image/re2/1745324409179.png)

ç„¶åå–œæŠ¥

![1745324460523](image/re2/1745324460523.png)

<Warning>Sorry, this node is too big to display </Warning>

è¿™ä¸ªèŠ‚ç‚¹å¤ªå¤§äº†ï¼Œæ˜¾ç¤ºä¸äº†ï¼Œä½†æ˜¯å¯ä»¥ä¿®æ”¹ `IDA/cfg/hexrays.cfg`çš„ `MAX_FUNCSIZE`ï¼Œé»˜è®¤åº”è¯¥æ˜¯64ï¼Œæ”¹æˆ1024å³å¯

![1745324813328](image/re2/1745324813328.png)

![1745324819137](image/re2/1745324819137.png)

å‘ç°å°±æ˜¯ä¸ªåŠ åŠ å‡å‡ç„¶åå’Œä¸€ä¸ªä¸œè¥¿æ¯”è¾ƒ

é‚£ä¸ªä¸œè¥¿æ˜¯

![1745325260154](image/re2/1745325260154.png)

æˆ‘åšçš„æ—¶å€™è¿˜ä¸ä¼šæå–è¿™ç©æ„

```python
res = []
with open("t.log", "r") as f:
    s = f.read()
    count = 0
    rcount = 0
    tmp = ""
    for line in s.split("\n"):
        line = line.split("db ")
        line = line[1][1:4].replace("h", "").replace(" ", "")
        count += 1
        tmp = line + tmp
        if count % 4 == 0:
            rcount += 1
            res.append(tmp)
            tmp = ""
        if rcount == 40:
            break

for i in range(40):
    print(f"v{i} = 0x{res[i]}")
```

åŸæ¥ <Kbd>Shift </Kbd>+<Kbd>E </Kbd> è¦é€‰ä¸­æ•°æ®æ‰èƒ½æå–

![1745325788780](image/re2/1745325788780.png)

æ¥ä¸‹æ¥å°±æ˜¯è§£å¯†ï¼Œæˆ‘ä»¬å‘ç°è¿™äº›æ•°ç»è¿‡ä¸€äº›åŠ å‡ç„¶åå†æ¯”è¾ƒ

é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥é€†å›å»ï¼ŒæŠŠæ¯”è¾ƒçš„æ•°åŠ å‡å›å»ï¼Œç„¶åå°±å¯ä»¥å¾—åˆ°flag

å…·ä½“å®ç°ä¸Šï¼Œå°±æ˜¯å€’ç€è¿è¡Œä»£ç ï¼Œç„¶ååŠ æ¢å‡ï¼Œå‡æ¢åŠ 

```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('solve.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

ans0 = 0xFFFFFF9A
ans1 = 0x0006D
ans2 = 0x0007E
....
ans38 = 0xFFFFFFED
ans39 = 0x00035
for i in range(2, 42):
    exec(f"v{i} = ans{i-2}")
with open("ori", "r") as f:
    s = f.read()
    lines = s.split("\n")
    lines.reverse()
    for line in lines:
        if "+=" in line:
            line = line.replace("+=", "-=")
        elif "-=" in line:
            line = line.replace("-=", "+=")
        elif "++" in line:
            line = line.split("++")
            line = line[1] + "-=1"
        elif "--" in line:
            line = line.split("--")
            line = line[1] + "+=1"
        exec(line)
        # logger.info(line)
for i in range(2, 42):
    exec(f"print(chr(v{i}%256),end='')")

```

## å‘

- ä»£ç é‡Œé¢æœ‰å°‘é‡çš„++vå’Œ--v è€Œév+=14 5000è¡Œé‡Œåªæœ‰10+ä¸ª
- ä¸è¦`line.replace("+=", "-=").replace("-=", "+=")`

# TEA

## é¢˜ç›®

[é¢˜ç›®é“¾æ¥](http://210.30.97.133:8000/challenges#TEA-264)

flagç”¨ `sssctf{}`åŒ…è£¹

## è§£é¢˜

å¼€å±€ä»ç„¶æ˜¯ <Kbd>Shift </Kbd>+<Kbd>F12 </Kbd>è·Ÿä¸Šé¢ä¸€æ ·æ‰¾åˆ°å…¥å£

![1745326592615](image/re2/1745326592615.png)

æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªçœ‹

```c
printf("Input:");
scanf("%s", Str);
if ( strlen(Str) != 32 )
  return -1;
```

è¾“å…¥é•¿åº¦å¿…é¡»ä¸º32ï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸‹é¢ `merge4`å‡½æ•°

```c
/*
char Str[100];
0 1 2 3 4 5 6 7 8 9 a b c d e f
(0) (1) (2) (3) (4) (5) (6) (7) (8) (9) (a) (b) (c) (d) (e) (f)
*/
int *__cdecl sub_4015AA(int a1, int a2)
{
  int *result; // eax
  int i; // [esp+Ch] [ebp-4h]

  for ( i = 0; i <= 7; ++i )
  {
    result = (int *)(4 * i + a2);
    /*
        #offset: 0 4 8 c
        #type: int* 4 bytes
    */
    *result = *(char *)(4 * i + 3 + a1) | (((((*(char *)(4 * i + a1) << 8) | *(char *)(4 * i + 1 + a1)) << 8) | *(char *)(4 * i + 2 + a1)) << 8);
    /*
        #addr:    0         4         8         c
        #offset: (0 1 2 3) (4 5 6 7) (8 9 a b) (c d e f)
    */
  }
  return result;
  /*
      _DWORD content[8];
      0 1 2 3 4 5 6 7 8 9 a b c d e f
      (0 1 2 3) (4 5 6 7) (8 9 a b) (c d e f)
  */
}
```

è¿™é‡Œæˆ‘ç”»äº†å†…å­˜çš„è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠchar[32]è½¬æ¢æˆint[8]å­˜åˆ°content

ç„¶åçœ‹ `merge2`å‡½æ•°

```c
/*
char Str[100];
0 1 2 3 4 5 6 7 8 9 a b c d e f
(0) (1) (2) (3) (4) (5) (6) (7) (8) (9) (a) (b) (c) (d) (e) (f)
*/

for ( i = 0; i <= 3; ++i )
{
    result = (int *)(4 * i + a2);
    /*
        #offset: 0 4 8 c
        #type: int* 4 bytes
    */

    *result = *(char *)(2 * i + 1 + a1) | (*(char *)(2 * i + a1) << 8); 
    /*
        #addr:    0         4         8         c
        #offset: (0 0 0 1) (0 0 2 3) (0 0 4 5) (0 0 6 7)
    */
}
/*
char key[16];
0 1 2 3 4 5 6 7 8 9 a b c d e f
(0) (0) (0) (1) (0) (0) (2) (3) (0) (0) (4) (5) (0) (0) (6) (7)
*/
```

è¿™é‡ŒæŠŠchar[32]å­˜åˆ°char[16] ä¸è¿‡å‘ç°è¿™é‡Œkeyåªç”¨åˆ°äº†**å‰8ä¸ªå­—èŠ‚** ä¹Ÿå°±æ˜¯å‰å…«ä¸ªchar

`tea`å‡½æ•°å…ˆæ”¾ç€ä¸ç®¡

`sub_401696((int)content, (int)dec_32);`åœ¨è¿™

```c
char Str[100]->Str[32]
char dec_32[400];
for ( i = 0; i <= 7; ++i )
{
    *(_DWORD *)(dec_32 + 16 * i) = HIBYTE(*(_DWORD *)(4 * i + content));
    *(_DWORD *)(dec_32 + 16 * i + 4) = (unsigned __int8)BYTE2(*(_DWORD *)(4 * i + content));
    *(_DWORD *)(dec_32 + 16 * i + 8) = (unsigned __int8)BYTE1(*(_DWORD *)(4 * i + content));
    *(_DWORD *)(dec_32 + 16 * i + 12 ) = (unsigned __int8)*(_DWORD *)(4 * i + content);
}
-user:
è¿™åœ¨åšä»€ä¹ˆ ç®€å•ç›´è§‚æ¦‚æ‹¬

-4o:
è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯ï¼š**å°†ä¸€ä¸ª 32 å­—èŠ‚çš„ç¼“å†²åŒºï¼ˆ`content` æŒ‡å‘ï¼‰ä¸­çš„æ¯ 4 å­—èŠ‚ï¼ˆä¸€ä¸ª `DWORD`ï¼‰åˆ†æ‹†æˆå­—èŠ‚åé‡æ–°æ’åˆ—ï¼Œå¹¶ä»¥ 16 å­—èŠ‚ä¸ºå•ä½å†™å…¥å¦ä¸€ä¸ªç¼“å†²åŒº `dec_32` ä¸­ã€‚**

ç®€å•ç›´è§‚åœ°è¯´å°±æ˜¯ï¼š

ğŸ‘‰ **æ¯4å­—èŠ‚æ‹†æˆ4ä¸ªå­—èŠ‚ï¼ŒæŒ‰ä»é«˜åˆ°ä½çš„é¡ºåºé‡æ–°æŒ‰åˆ—æ’å¸ƒåˆ°æ–°çš„å†…å­˜ä¸­ï¼Œæ¯æ¬¡å†™å…¥16å­—èŠ‚ï¼Œå…±8ç»„ã€‚**

ä¾‹å¦‚ï¼š
å‡è®¾ `content` é‡Œçš„å‰4å­—èŠ‚æ˜¯ `0xAABBCCDD`ï¼Œè¿™æ®µä»£ç ä¼šæŠŠï¼š
- `AA`ï¼ˆé«˜å­—èŠ‚ï¼‰æ”¾åˆ°æ–°ä½ç½®çš„åç§»0
- `BB` æ”¾åç§»4
- `CC` æ”¾åç§»8
- `DD` æ”¾åç§»12
ç„¶åå¤„ç†ä¸‹ä¸€ä¸ª4å­—èŠ‚ï¼Œå†æ”¾å…¥ä¸‹ä¸€ç»„16å­—èŠ‚ï¼Œä»¥æ­¤ç±»æ¨ï¼Œé‡å¤8æ¬¡ã€‚

ç»“æœï¼šæŠŠåŸå§‹çš„"æŒ‰è¡Œæ’åˆ—"çš„ç»“æ„ï¼Œå˜æˆäº†"æŒ‰åˆ—æ’åˆ—"çš„ç»“æ„ï¼Œæœ‰ç‚¹ç±»ä¼¼çŸ©é˜µè½¬ç½®é‚£ç§æ„Ÿè§‰ã€‚é€‚åˆäºåç»­çš„åŠ å¯†æˆ–è§£ç å¤„ç†ã€‚
```

è¿™æ˜¯æ¯”è¾ƒå‡½æ•°

![1745327408375](image/re2/1745327408375.png)

æ‰€ä»¥æˆ‘ä»¬ç«‹é©¬å°±èƒ½
```python
v2 = [0]*32
v2[0] = 176
v2[1] = 71
...
v2[28] = 58
v2[29] = 94
v2[30] = 28
v2[31] = 205
encrypt_data = [0]*8
for i in range(8):
    encrypt_data[i] = v2[i*4] << 24 | v2[i*4+1] << 16 | v2[i*4+2] << 8 | v2[i*4+3]
```

æˆ‘ä»¬çŸ¥é“åŠ å¯†æ˜¯éœ€è¦å¯†é’¥çš„ï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹å¹¶æ€»ç»“

- æ˜æ–‡æ˜¯ç”±æˆ‘ä»¬è¾“å…¥çš„32å­—èŠ‚
- å¯†é’¥æ˜¯æ˜æ–‡çš„å‰8ä¸ªå­—èŠ‚
- åŠ å¯†å‡½æ•°æ˜¯`TEA`
- å¯†æ–‡æ˜¯`encrypt_data`

è¿˜è®°å¾—é¢˜ç›®ä¸€å¼€å§‹è¯´çš„å—ï¼Œflagæ˜¯`sssctf{}`åŒ…è£¹çš„ï¼Œæ‰€ä»¥å¯†é’¥çš„å‰7ä¸ªå­—èŠ‚æ˜¯`sssctf{`ï¼Œåªéœ€çˆ†ç ´æœ€åä¸€ä¸ªå­—èŠ‚å³å¯
```python
guess = []
guess += [chr(i) for i in range(ord('a'), ord('z')+1)]
guess += [chr(i) for i in range(ord('A'), ord('Z')+1)]
guess += [chr(i) for i in range(ord('0'), ord('9')+1)]
guess += ['!', '@', '#', '$', '%', '^', '&', '*',
          '(', ')', '-', '_', '+', '=', '{', '}', '[', ']', '|', ':', ';', ',', '.', '/', '?', '~'] # è¿™ä¸€è¡Œæ˜¯aiè¡¥å…¨çš„ æˆ‘ä¸ç¡®å®šæœ‰æ²¡æœ‰è¿™ä¹ˆå¤š
```

ç„¶åçœ‹`tea`å‡½æ•°

```c
unsigned int __cdecl tea(_DWORD *ori, int a2, int key)
{
  unsigned int *v3; // eax
  unsigned int *v4; // eax
  unsigned int result; // eax
  int v6; // [esp+Ch] [ebp-1Ch]
  int index; // [esp+10h] [ebp-18h]
  unsigned int i; // [esp+14h] [ebp-14h]
  unsigned int v9; // [esp+18h] [ebp-10h]
  unsigned int v10; // [esp+1Ch] [ebp-Ch]

  if ( a2 > 1 )
  {
    index = 52 / a2 + 6;                        // 12
    v9 = 0;
    v10 = ori[a2 - 1];
    do
    {
      v9 -= 1640531527;
      v6 = (v9 >> 2) & 3;
      for ( i = 0; i < a2 - 1; ++i )
      {
        v3 = &ori[i];
        *v3 += ((ori[i + 1] ^ v9) + (v10 ^ *(_DWORD *)(4 * (v6 ^ i & 3) + key))) ^ (((4 * ori[i + 1]) ^ (v10 >> 5))
                                                                                  + ((ori[i + 1] >> 3) ^ (16 * v10)));
        v10 = *v3;
      }
      v4 = &ori[a2 - 1];
      *v4 += ((*ori ^ v9) + (v10 ^ *(_DWORD *)(4 * (v6 ^ i & 3) + key))) ^ (((4 * *ori) ^ (v10 >> 5))
                                                                          + ((*ori >> 3) ^ (16 * v10)));
      result = *v4;
      v10 = result;
      --index;
    }
    while ( index );
  }
  return result;
}
```
è¿™ç©æ„é‡Œé¢æŒºæ··æ·†çš„ï¼Œæˆ‘å¤´å‘è€—å…‰äº†æŠŠé‚£ä¸€å †ä¸œè¥¿åŒ–ç®€æˆè¿™æ ·ï¼Œè‡ªå·±éƒ½æ²¡æƒ³åˆ°èƒ½å¦‚æ­¤ç®€æ´ï¼Œè¿™è¯¥ä¸ä¼šæ˜¯**reçš„ç²¾é«“**å§

```c
index = 12;
sum = 0;
o7 = ori[7];
do
{
    sum -= 0x61C88647;
    sum2 = (sum >> 2) & 3;
    for (i=0; i < 7; ++i)
    {
        ori[i] += ((ori[(i+1) % 8] ^ sum) + (ori[(i-1) % 8] ^ *(_DWORD *)(4 * (sum2 ^ i & 3) + key))) ^ (((4 * ori[(i+1) % 8]) ^ (ori[(i-1) % 8] >> 5)) + ((ori[(i+1) % 8] >> 3) ^ (16 * ori[(i-1) % 8])));
    }
    --index;
}
while (index);
```

æ¥ä¸‹æ¥å‚è€ƒäº†æ–‡ç« [tea åŠ å¯†è§£å¯†ç®—æ³•ï¼ˆé¢å‘ctf-reverseä½¿ç”¨ï¼Œå…‰é€Ÿå­¦ä¼šteaé€†å‘å¥—è·¯ï¼‰](https://blog.csdn.net/liKeQing1027520/article/details/141287289)

(å®é™…ä¸Šåœ¨åŒ–ç®€å‰å°±çœ‹æ–‡ç« äº† è€—äº†å¤§åŠå¤©ä¸€ç›´è§‰å¾—æˆ‘é‡åˆ°çš„è¿™ä¸ªTEAæ˜¯è¶…çº§å¤æ‚çš„TEA)

teaè§£å¯†å…¶å®è·Ÿä¸Šé¢é‚£é“é¢˜ç±»ä¼¼ï¼Œä»ç„¶æ˜¯å€’ç€è¿è¡Œï¼Œç„¶ååŠ æ¢å‡ï¼Œå‡æ¢åŠ 

è¿™é‡Œå¼‚æˆ–å°±ä¸ç”¨ç®¡äº†ï¼Œå› ä¸ºå¼‚æˆ–çš„é€†è¿ç®—å°±æ˜¯å¼‚æˆ–ï¼Œå’Œä¸Šé¢ä¸€é¢˜ä¸€æ ·

`sum`çš„åˆå§‹å€¼æ˜¯`0x61C88647 * -index`

ç„¶å`python`çš„è¯æ³¨æ„è¦æ‰‹åŠ¨æº¢å‡º`& 0xFFFFFFFF`

```python 
for ch in guess:
    key_str = "sssctf{"+ch  # 8 char
    key = [0]*4
    for i in range(0, 4):
        key[i] = ord(key_str[i*2+1]) | (ord(key_str[i*2]) << 8)
        # TEAè§£å¯†
        ori = encrypt_data.copy()
        index = 12
        sum = (0x61C88647 * -index) & 0xFFFFFFFF
        while index > 0:
            sum2 = (sum >> 2) & 3
            for i in range(7, -1, -1):
                ori[i] -= ((ori[(i+1) % 8] ^ sum) + (ori[(i-1) % 8] ^ key[sum2 ^ (i & 3)])) ^ (
                    ((4 * ori[(i+1) % 8]) ^ (ori[(i-1) % 8] >> 5)) + ((ori[(i+1) % 8] >> 3) ^ (16 * ori[(i-1) % 8])))
                ori[i] &= 0xFFFFFFFF
            sum += 0x61C88647
            sum &= 0xFFFFFFFF
            index -= 1
        # output:
        decrypted_text = ""
        for value in ori:
            decrypted_text += chr((value >> 24) & 0xFF)
            decrypted_text += chr((value >> 16) & 0xFF)
            decrypted_text += chr((value >> 8) & 0xFF)
            decrypted_text += chr(value & 0xFF)
        print(f"ä½¿ç”¨å¯†é’¥ {key_str} è§£å¯†ç»“æœ: {decrypted_text}")
        if decrypted_text.startswith("sssctf{"):
            print(f"æ‰¾åˆ°å¯†é’¥: {key_str}")
            break
```

# æ€»ç»“

- ä¸¤é“é¢˜éš¾åº¦å·®è·ä¸å°ï¼Œä½†æ ¸å¿ƒæ€æƒ³æŒºåƒçš„ï¼Œéƒ½æ˜¯é€†å‘ï¼ˆå­—é¢æ„æ€ï¼‰é€†ç€è¿è¡Œ
- å†™ç­‰ä»·ä»£ç è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„
- åœ¨è¿ç®—ä¸­è¦è€ƒè™‘æ•°æ®ç±»å‹ æ¯”å¦‚è¿™é“é¢˜ç›´æ¥å†³å®šäº†8å­—èŠ‚å¯†é’¥åªéœ€è¦çˆ†ç ´ä¸€ä¸ªå­—èŠ‚ å¦‚æœåªçœ‹char[16]çš„è¯ å¯èƒ½çœŸçš„è§‰å¾—è¦çˆ†ç ´9ä¸ªå­—èŠ‚

