<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒå‰æ ‘æœ€è¿‘å…¬å…±ç¥–å…ˆ (LCA) å¯è§†åŒ–</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --primary: #3b82f6;
            --success: #10b981;
            --target-p: #f59e0b;
            --target-q: #ec4899;
            --lca-color: #8b5cf6;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            box-sizing: border-box;
        }

        h1 {
            color: var(--text-main);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .container {
            display: flex;
            gap: 20px;
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .canvas-area {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        canvas {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            width: 100%;
            height: 100%;
        }

        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn-start { background-color: var(--primary); color: white; }
        .btn-start:hover { background-color: #2563eb; }
        .btn-step { background-color: var(--success); color: white; }
        .btn-step:hover { background-color: #059669; }
        .btn-reset { background-color: #ef4444; color: white; }
        .btn-reset:hover { background-color: #dc2626; }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .log-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e5e7eb;
            padding-left: 20px;
            min-width: 300px;
        }

        .log-header {
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 5px;
        }

        #log-list {
            flex: 1;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #log-list li {
            padding: 8px;
            border-bottom: 1px solid #f3f4f6;
            line-height: 1.4;
        }

        #log-list li.highlight {
            background-color: #eff6ff;
            border-left: 3px solid var(--primary);
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.8rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .code-snippet {
            background: #282c34;
            color: #abb2bf;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 10px;
            overflow-x: auto;
        }
        
        .code-highlight {
            background-color: #3e4451;
            display: block;
        }

    </style>
</head>
<body>

    <h1>äºŒå‰æ ‘æœ€è¿‘å…¬å…±ç¥–å…ˆ (LeetCode 236)</h1>

    <div class="container">
        <div class="canvas-area">
            <canvas id="treeCanvas" width="800" height="500"></canvas>
            
            <div class="legend">
                <div class="legend-item"><div class="dot" style="background:var(--primary)"></div> æ­£åœ¨è®¿é—®</div>
                <div class="legend-item"><div class="dot" style="background:var(--target-p)"></div> ç›®æ ‡ P (6)</div>
                <div class="legend-item"><div class="dot" style="background:var(--target-q)"></div> ç›®æ ‡ Q (4)</div>
                <div class="legend-item"><div class="dot" style="background:var(--success)"></div> è¿”å›æœ‰æ•ˆèŠ‚ç‚¹</div>
                <div class="legend-item"><div class="dot" style="background:var(--lca-color)"></div> å‘ç° LCA (5)</div>
            </div>

            <div class="controls">
                <button id="btnStart" class="btn-start" onclick="startAuto()">è‡ªåŠ¨æ’­æ”¾</button>
                <button id="btnStep" class="btn-step" onclick="step()">ä¸‹ä¸€æ­¥</button>
                <button id="btnReset" class="btn-reset" onclick="reset()">é‡ç½®</button>
                <div style="display:flex; align-items:center; gap:5px; margin-left:10px;">
                    <label for="speedRange" style="font-size:0.9rem;">é€Ÿåº¦:</label>
                    <input type="range" id="speedRange" min="100" max="2000" value="1000" style="width:100px;">
                </div>
            </div>
        </div>

        <div class="log-area">
            <div class="log-header">ç®—æ³•æ‰§è¡Œæ—¥å¿—</div>
            <ul id="log-list">
                <li style="color:#888;">ç‚¹å‡»â€œè‡ªåŠ¨æ’­æ”¾â€æˆ–â€œä¸‹ä¸€æ­¥â€å¼€å§‹...</li>
            </ul>
            <div class="code-snippet">
<pre>
<span id="code-entry">function lowestCommonAncestor(root, p, q) {</span>
<span id="code-base">  if (!root || root == p || root == q) return root;</span>
<span id="code-left">  let left = lowestCommonAncestor(root.left, p, q);</span>
<span id="code-right">  let right = lowestCommonAncestor(root.right, p, q);</span>
<span id="code-lca">  if (left && right) return root; // LCA!</span>
<span id="code-return">  return left ? left : right;</span>
}
</pre>
            </div>
        </div>
    </div>

<script>
    // --- æ ‘çš„æ•°æ®ç»“æ„ä¸é…ç½® ---
    const canvas = document.getElementById('treeCanvas');
    const ctx = canvas.getContext('2d');
    
    // å®šä¹‰æ ‘ç»“æ„ï¼šä¸ºäº†æ¼”ç¤º LCAï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªç¨å¾®æ·±ä¸€ç‚¹çš„æ ‘
    // Root: 3
    // L: 5, R: 1
    // 5 -> L: 6, R: 2
    // 1 -> L: 0, R: 8
    // 2 -> L: 7, R: 4
    // ç›®æ ‡: p = 6, q = 4.  LCA åº”è¯¥æ˜¯ 5.
    
    const treeData = {
        val: 3,
        id: 3,
        x: 400, y: 50,
        left: {
            val: 5, id: 5, x: 250, y: 150,
            left: { val: 6, id: 6, x: 180, y: 250, left: null, right: null },
            right: { 
                val: 2, id: 2, x: 320, y: 250,
                left: { val: 7, id: 7, x: 280, y: 350, left: null, right: null },
                right: { val: 4, id: 4, x: 360, y: 350, left: null, right: null }
            }
        },
        right: {
            val: 1, id: 1, x: 550, y: 150,
            left: { val: 0, id: 0, x: 480, y: 250, left: null, right: null },
            right: { val: 8, id: 8, x: 620, y: 250, left: null, right: null }
        }
    };

    const targetP = 6;
    const targetQ = 4;
    
    // --- ç»˜åˆ¶ç›¸å…³å˜é‡ ---
    const radius = 25;
    const colors = {
        default: '#fff',
        stroke: '#333',
        visiting: '#3b82f6', // Blue
        targetP: '#f59e0b', // Orange
        targetQ: '#ec4899', // Pink
        found: '#10b981',   // Green (bubbling up)
        lca: '#8b5cf6',     // Purple
        nullNode: '#ddd'
    };

    // åŠ¨ç”»çŠ¶æ€æ§åˆ¶
    let generator; // ç”Ÿæˆå™¨å®ä¾‹
    let isAutoPlaying = false;
    let autoPlayTimer = null;
    
    // çŠ¶æ€è®°å½• (ç”¨äºç»˜åˆ¶)
    let currentNodeId = null;
    let foundNodes = new Set(); // å·²ç»ç¡®è®¤æ‰¾åˆ°å¹¶è¿”å›çš„è·¯å¾„èŠ‚ç‚¹
    let lcaNodeId = null;
    let activePath = []; // å½“å‰é€’å½’æ ˆè·¯å¾„
    let returnValues = {}; // è®°å½•æ¯ä¸ªèŠ‚ç‚¹è¿”å›çš„å€¼ (ç”¨äºæ˜¾ç¤º)

    // --- æ ¸å¿ƒç®—æ³•é€»è¾‘ (Generator) ---
    // ä½¿ç”¨ Generator å‡½æ•°å¯ä»¥æ–¹ä¾¿åœ°å®ç°"æš‚åœ"å’Œ"ä¸‹ä¸€æ­¥"
    function* lcaAlgorithm(node) {
        if (!node) {
            log(`é‡åˆ° nullï¼Œè¿”å› null`);
            yield { type: 'null' };
            return null;
        }

        currentNodeId = node.id;
        activePath.push(node.id);
        highlightCode('code-entry');
        log(`è®¿é—®èŠ‚ç‚¹ ${node.val}`);
        draw();
        yield { type: 'visit', node: node };

        // æ£€æŸ¥ Base Case
        highlightCode('code-base');
        if (node.val === targetP || node.val === targetQ) {
            let targetName = node.val === targetP ? 'P' : 'Q';
            log(`å‘ç°ç›®æ ‡ ${targetName} (${node.val})! è¿”å›èŠ‚ç‚¹ ${node.val}`);
            foundNodes.add(node.id);
            returnValues[node.id] = node.val;
            draw();
            yield { type: 'found', node: node };
            activePath.pop();
            return node.val;
        }

        // é€’å½’å·¦å­æ ‘
        highlightCode('code-left');
        log(`èŠ‚ç‚¹ ${node.val} å‘å·¦é€’å½’...`);
        yield { type: 'go_left', node: node };
        
        const leftResult = yield* lcaAlgorithm(node.left);
        
        // æ¢å¤å½“å‰ç¯å¢ƒ
        currentNodeId = node.id;
        highlightCode('code-right');
        log(`èŠ‚ç‚¹ ${node.val} å·¦ä¾§è¿”å›: ${leftResult !== null ? leftResult : 'null'}ã€‚å‡†å¤‡å‘å³é€’å½’...`);
        draw();
        yield { type: 'back_to_node', node: node };

        // é€’å½’å³å­æ ‘
        const rightResult = yield* lcaAlgorithm(node.right);

        // æ¢å¤å½“å‰ç¯å¢ƒ
        currentNodeId = node.id;
        log(`èŠ‚ç‚¹ ${node.val} å³ä¾§è¿”å›: ${rightResult !== null ? rightResult : 'null'}`);
        draw();
        yield { type: 'back_to_node', node: node };

        // å¤„ç†ç»“æœ
        highlightCode('code-lca');
        if (leftResult !== null && rightResult !== null) {
            lcaNodeId = node.id;
            log(`ğŸ‰ èŠ‚ç‚¹ ${node.val} å·¦ä¾§æ‰¾åˆ° ${leftResult}, å³ä¾§æ‰¾åˆ° ${rightResult}ã€‚`);
            log(`>> å› æ­¤ ${node.val} æ˜¯æœ€è¿‘å…¬å…±ç¥–å…ˆ (LCA)!`);
            highlightCode('code-lca');
            draw();
            yield { type: 'lca_found', node: node };
            
            activePath.pop();
            return node.val; // è¿™é‡Œè™½ç„¶è¿”å›äº†ï¼Œä½†å¯¹äº LeetCode é€»è¾‘ï¼Œè¿™å°±æ˜¯ç»“æœ
        }

        highlightCode('code-return');
        let result = leftResult !== null ? leftResult : rightResult;
        
        if (result !== null) {
            log(`èŠ‚ç‚¹ ${node.val} æ”¶åˆ°å­æ ‘è¿”å› ${result}ï¼Œç»§ç»­å‘ä¸Šè¿”å› ${result}`);
            foundNodes.add(node.id); // æ ‡è®°ä¸ºè·¯å¾„ä¸Šçš„ä¸€å‘˜
            returnValues[node.id] = result;
        } else {
            log(`èŠ‚ç‚¹ ${node.val} å·¦å³å‡æœªå‘ç°ç›®æ ‡ï¼Œè¿”å› null`);
        }

        draw();
        yield { type: 'return', result: result };
        
        activePath.pop();
        return result;
    }

    // --- ç»˜åˆ¶å‡½æ•° ---

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawTreeRecursive(treeData);
    }

    function drawTreeRecursive(node) {
        if (!node) return;

        // ç»˜åˆ¶è¿çº¿
        if (node.left) drawLine(node, node.left);
        if (node.right) drawLine(node, node.right);

        // é€’å½’ç»˜åˆ¶å­èŠ‚ç‚¹
        drawTreeRecursive(node.left);
        drawTreeRecursive(node.right);

        // ç»˜åˆ¶èŠ‚ç‚¹æœ¬èº«
        drawNodeCircle(node);
    }

    function drawLine(parent, child) {
        ctx.beginPath();
        ctx.moveTo(parent.x, parent.y);
        ctx.lineTo(child.x, child.y);
        
        // å¦‚æœå­èŠ‚ç‚¹è¿”å›äº†æœ‰æ•ˆå€¼ï¼Œçº¿å˜ç»¿
        if (returnValues[child.id] !== undefined && returnValues[child.id] !== null) {
            ctx.strokeStyle = colors.found;
            ctx.lineWidth = 4;
        } else if (activePath.includes(parent.id) && activePath.includes(child.id) && currentNodeId === child.id) {
             // æ­£åœ¨å‘ä¸‹æ¢ç´¢
             ctx.strokeStyle = colors.visiting;
             ctx.lineWidth = 3;
        } else {
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 2;
        }
        
        ctx.stroke();
    }

    function drawNodeCircle(node) {
        ctx.beginPath();
        ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI);
        
        // å†³å®šå¡«å……é¢œè‰²
        let fill = colors.default;
        let stroke = colors.stroke;
        let textCol = '#333';

        if (node.id === lcaNodeId) {
            fill = colors.lca;
            textCol = '#fff';
        } else if (node.val === targetP) {
            fill = colors.targetP;
            textCol = '#fff';
        } else if (node.val === targetQ) {
            fill = colors.targetQ;
            textCol = '#fff';
        } else if (node.id === currentNodeId) {
            fill = colors.visiting;
            textCol = '#fff';
        } else if (foundNodes.has(node.id)) {
            // è¿™é‡Œè¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹è™½ç„¶ä¸æ˜¯Pæˆ–Qï¼Œä½†æ˜¯å®ƒè¿”å›äº†æœ‰æ•ˆå€¼ï¼ˆåœ¨è·¯å¾„ä¸Šï¼‰
            fill = '#d1fae5'; // light green
            stroke = colors.found;
        }

        ctx.fillStyle = fill;
        ctx.fill();
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 3;
        ctx.stroke();

        // ç»˜åˆ¶æ•°å€¼
        ctx.fillStyle = textCol;
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(node.val, node.x, node.y);

        // ç»˜åˆ¶è¿”å›å€¼çš„æ°”æ³¡ï¼ˆå¦‚æœæœ‰ï¼‰
        if (returnValues[node.id] !== undefined) {
            ctx.fillStyle = colors.found;
            ctx.font = 'bold 12px Arial';
            ctx.fillText(`ret: ${returnValues[node.id]}`, node.x + 35, node.y - 10);
        }
    }

    // --- äº¤äº’æ§åˆ¶é€»è¾‘ ---

    function log(message) {
        const list = document.getElementById('log-list');
        const li = document.createElement('li');
        li.innerText = message;
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        list.appendChild(li);
        list.scrollTop = list.scrollHeight;
        
        // é«˜äº®æœ€æ–°ä¸€æ¡
        const items = list.querySelectorAll('li');
        items.forEach(i => i.classList.remove('highlight'));
        li.classList.add('highlight');
    }

    function highlightCode(id) {
        document.querySelectorAll('.code-snippet span').forEach(el => el.classList.remove('code-highlight'));
        const el = document.getElementById(id);
        if (el) el.classList.add('code-highlight');
    }

    function init() {
        generator = lcaAlgorithm(treeData);
        draw();
        log("å‡†å¤‡å°±ç»ªã€‚å¯»æ‰¾ P=6 å’Œ Q=4 çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚");
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnStep').disabled = false;
    }

    function step() {
        if (!generator) return;
        
        const res = generator.next();
        if (res.done) {
            isAutoPlaying = false;
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStep').disabled = true;
            log("--- ç®—æ³•æ‰§è¡Œç»“æŸ ---");
            if (autoPlayTimer) clearTimeout(autoPlayTimer);
            return;
        }
        // å¦‚æœè‡ªåŠ¨æ’­æ”¾ä¸­ï¼Œç»§ç»­ä¸‹ä¸€æ­¥
        if (isAutoPlaying) {
            const speed = 2100 - document.getElementById('speedRange').value;
            autoPlayTimer = setTimeout(step, speed);
        }
    }

    function startAuto() {
        if (isAutoPlaying) return;
        isAutoPlaying = true;
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStep').disabled = true; // è‡ªåŠ¨æ’­æ”¾æ—¶ç¦ç”¨å•æ­¥
        step();
    }

    function reset() {
        isAutoPlaying = false;
        if (autoPlayTimer) clearTimeout(autoPlayTimer);
        
        currentNodeId = null;
        foundNodes.clear();
        lcaNodeId = null;
        activePath = [];
        returnValues = {};
        
        document.getElementById('log-list').innerHTML = '';
        document.querySelectorAll('.code-snippet span').forEach(el => el.classList.remove('code-highlight'));
        
        init();
    }

    // åˆå§‹åŒ–
    init();

</script>
</body>
</html>