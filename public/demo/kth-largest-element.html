<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeetCode 215: 数组中的第 K 个最大元素 (Quick Select)</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --primary: #3b82f6;
            --pivot-color: #f59e0b; /* Orange */
            --less-color: #ef4444;  /* Red */
            --greater-color: #10b981; /* Green */
            --sorted-color: #8b5cf6; /* Purple */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        h1 { margin-bottom: 10px; }
        .subtitle { color: #aaa; margin-bottom: 20px; font-size: 0.9em; }

        .main-container {
            display: flex;
            gap: 20px;
            width: 100%;
            max-width: 1400px; /* Wider container */
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
        }

        /* Visualization Area */
        .viz-section {
            flex: 2;
            min-width: 350px;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        input[type="text"], input[type="number"] {
            background: #404040;
            border: 1px solid #555;
            color: white;
            padding: 8px;
            border-radius: 4px;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        button:hover { background: #2563eb; }
        button:disabled { background: #555; cursor: not-allowed; }
        button.secondary { background: #4b5563; }
        button.secondary:hover { background: #6b7280; }

        .array-container {
            position: relative;
            height: 300px; /* Taller for bars */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align bars to bottom */
            margin: 20px 0 40px 0; /* Extra margin bottom for pointers */
            border-bottom: 1px solid #444;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        .block {
            background: #4b5563;
            border-radius: 4px 4px 0 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Text at top of bar */
            align-items: center;
            font-weight: bold;
            font-size: 0.8rem;
            position: absolute; 
            bottom: 0;
            transition: left 0.3s ease, background-color 0.2s, height 0.3s, transform 0.3s;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.2);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .block span {
            margin-top: 5px;
            text-shadow: 0 1px 2px black;
            font-size: 0.7rem;
        }

        /* Hide text if bars are too thin */
        .block.thin span { display: none; }

        /* Block States */
        .block.pivot { background: var(--pivot-color); z-index: 10; border: 1px solid white; }
        .block.less { background: var(--less-color); } 
        .block.greater { background: var(--greater-color); } 
        .block.found { background: var(--sorted-color); border: 2px solid #fff; box-shadow: 0 0 15px var(--sorted-color); z-index: 20; }
        .block.active { opacity: 0.8; filter: brightness(1.2); }
        
        .status-panel {
            margin-top: 10px;
            padding: 10px;
            background: #222;
            border-radius: 6px;
            width: 95%;
            text-align: center;
            min-height: 40px;
            border-left: 4px solid var(--primary);
            font-size: 0.9rem;
        }

        .pointers {
            height: 0; /* Pointers are absolute relative to this container */
            width: 100%;
            position: relative;
            top: -10px; /* Pull up closer to bars */
        }
        
        .pointer-marker {
            position: absolute;
            font-size: 16px;
            text-align: center;
            transition: left 0.3s ease;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
        }
        
        .pointer-marker .arrow {
            font-size: 1.2rem;
            line-height: 1;
        }
        
        .pointer-marker .label {
            font-size: 0.7rem;
            background: rgba(0,0,0,0.7);
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* Code Section */
        .code-section {
            flex: 1;
            min-width: 300px;
            max-height: 500px; /* Limit height */
            overflow-y: auto; /* Scroll inside */
            background: #1e1e1e;
            border-radius: 12px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            border: 1px solid #333;
        }

        /* Scrollbar styling */
        .code-section::-webkit-scrollbar { width: 8px; height: 8px; }
        .code-section::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .code-section::-webkit-scrollbar-track { background: #1e1e1e; }

        pre { margin: 0; }
        code { color: #d4d4d4; }
        .keyword { color: #569cd6; }
        .function { color: #dcdcaa; }
        .number { color: #b5cea8; }
        .comment { color: #6a9955; }
        .string { color: #ce9178; }

        .line {
            padding: 1px 5px;
            border-left: 3px solid transparent;
            width: 100%;
            box-sizing: border-box;
        }
        .line.active-line {
            background-color: #37373d;
            border-left-color: var(--primary);
        }

        /* Explanation Box */
        .legend {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            font-size: 0.8rem;
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px;
            background: #252525;
            border-radius: 8px;
            width: 95%;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 10px; height: 10px; border-radius: 2px; }

    </style>
</head>
<body>

    <h1>数组中的第 K 个最大元素</h1>
    <div class="subtitle">LeetCode 215 - 快速选择算法 (柱状图演示)</div>

    <div class="main-container">
        
        <!-- Visualization Area -->
        <div class="viz-section">
            <div class="controls">
                <button onclick="randomizeArray()" class="secondary">随机生成(50)</button>
                <div style="display:flex; align-items:center; gap:5px;">
                    <label style="font-size:0.8rem">K:</label>
                    <input type="number" id="kInput" value="5" min="1" style="width: 40px;">
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <label style="font-size:0.8rem">速度:</label>
                    <input type="range" id="speedRange" min="10" max="800" value="100" style="direction: rtl; width: 100px;"> 
                </div>
                <button onclick="startVisualization()" id="startBtn">开始演示</button>
                <button onclick="resetVisualization()" id="resetBtn">重置</button>
            </div>
            
            <!-- Hidden input for manual override if needed -->
            <input type="text" id="arrayInput" style="display:none;">

            <div class="status-panel" id="statusText">准备就绪... 点击开始</div>

            <div class="array-container" id="arrayContainer">
                <!-- Bars generated by JS -->
            </div>
            
            <div class="pointers" id="pointersContainer">
                <!-- Pointer labels -->
            </div>

            <div class="legend">
                <div class="legend-item"><div class="dot" style="background:var(--pivot-color)"></div>Pivot(基准)</div>
                <div class="legend-item"><div class="dot" style="background:var(--less-color)"></div>小于 Pivot</div>
                <div class="legend-item"><div class="dot" style="background:var(--greater-color)"></div>大于(未处理)</div>
                <div class="legend-item"><div class="dot" style="background:#4b5563"></div>默认</div>
                <div class="legend-item"><div class="dot" style="background:var(--sorted-color)"></div>目标(第K大)</div>
            </div>
        </div>

        <!-- Code Area -->
        <div class="code-section" id="codeContainer">
<pre><code>
<div class="line" id="line-1"><span class="keyword">function</span> <span class="function">findKthLargest</span>(nums, k) {</div>
<div class="line" id="line-2">    <span class="comment">// 第K大 = 排序后索引 length - k</span></div>
<div class="line" id="line-3">    <span class="keyword">let</span> target = nums.length - k;</div>
<div class="line" id="line-4">    <span class="keyword">return</span> <span class="function">quickSelect</span>(nums, 0, nums.length - 1, target);</div>
<div class="line" id="line-5">}</div>
<br>
<div class="line" id="line-6"><span class="keyword">function</span> <span class="function">quickSelect</span>(nums, left, right, target) {</div>
<div class="line" id="line-7">    <span class="keyword">if</span> (left === right) <span class="keyword">return</span> nums[left];</div>
<div class="line" id="line-8">    </div>
<div class="line" id="line-9">    <span class="comment">// 进行分区，返回 pivot 的最终索引</span></div>
<div class="line" id="line-10">    <span class="keyword">let</span> pIndex = <span class="function">partition</span>(nums, left, right);</div>
<div class="line" id="line-11">    </div>
<div class="line" id="line-12">    <span class="keyword">if</span> (target === pIndex) {</div>
<div class="line" id="line-13">        <span class="keyword">return</span> nums[pIndex];</div>
<div class="line" id="line-14">    } <span class="keyword">else</span> <span class="keyword">if</span> (target < pIndex) {</div>
<div class="line" id="line-15">        <span class="keyword">return</span> <span class="function">quickSelect</span>(nums, left, pIndex - 1, target);</div>
<div class="line" id="line-16">    } <span class="keyword">else</span> {</div>
<div class="line" id="line-17">        <span class="keyword">return</span> <span class="function">quickSelect</span>(nums, pIndex + 1, right, target);</div>
<div class="line" id="line-18">    }</div>
<div class="line" id="line-19">}</div>
<br>
<div class="line" id="line-20"><span class="keyword">function</span> <span class="function">partition</span>(nums, left, right) {</div>
<div class="line" id="line-21">    <span class="keyword">let</span> pivot = nums[right];</div>
<div class="line" id="line-22">    <span class="keyword">let</span> storeIndex = left;</div>
<div class="line" id="line-23">    </div>
<div class="line" id="line-24">    <span class="keyword">for</span> (<span class="keyword">let</span> i = left; i < right; i++) {</div>
<div class="line" id="line-25">        <span class="keyword">if</span> (nums[i] <= pivot) {</div>
<div class="line" id="line-26">            <span class="function">swap</span>(nums, storeIndex, i);</div>
<div class="line" id="line-27">            storeIndex++;</div>
<div class="line" id="line-28">        }</div>
<div class="line" id="line-29">    }</div>
<div class="line" id="line-30">    <span class="function">swap</span>(nums, storeIndex, right);</div>
<div class="line" id="line-31">    <span class="keyword">return</span> storeIndex;</div>
<div class="line" id="line-32">}</div>
</code></pre>
        </div>
    </div>

    <script>
        // State variables
        let arrayData = [];
        let delayTime = 100;
        let isRunning = false;
        let abortController = null;

        // DOM Elements
        const container = document.getElementById('arrayContainer');
        const statusText = document.getElementById('statusText');
        const startBtn = document.getElementById('startBtn');
        const pointersContainer = document.getElementById('pointersContainer');
        const codeContainer = document.getElementById('codeContainer');

        // Initialization
        window.onload = () => {
            randomizeArray(); // Start with random big data
        };

        document.getElementById('speedRange').addEventListener('input', (e) => {
            delayTime = parseInt(e.target.value);
        });

        document.getElementById('kInput').addEventListener('change', initArray);

        function randomizeArray() {
            if(isRunning) return;
            // Generate 50 random numbers between 5 and 100
            const newData = Array.from({length: 50}, () => Math.floor(Math.random() * 95) + 5);
            document.getElementById('arrayInput').value = newData.join(',');
            initArray();
        }

        function initArray() {
            if(isRunning) return;
            const inputVal = document.getElementById('arrayInput').value;
            if(!inputVal) {
                 randomizeArray();
                 return;
            }
            arrayData = inputVal.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            renderArray();
            clearPointers();
            resetLines();
            statusText.innerText = `数据量: ${arrayData.length} | 准备就绪`;
            statusText.style.color = "#fff";
        }

        function renderArray() {
            container.innerHTML = '';
            const containerWidth = container.offsetWidth;
            const len = arrayData.length;
            
            // Calculate dimensions
            const gap = len > 30 ? 1 : 2; // Smaller gap for more items
            const availableWidth = containerWidth - (gap * (len - 1));
            const barWidth = Math.floor(availableWidth / len);
            const maxVal = Math.max(...arrayData, 100);

            // Center the chart
            const totalWidth = (barWidth + gap) * len - gap;
            const startX = (containerWidth - totalWidth) / 2;

            arrayData.forEach((val, idx) => {
                const el = document.createElement('div');
                el.classList.add('block');
                if (barWidth < 25) el.classList.add('thin'); // Hide text if too thin
                
                el.id = `block-${idx}`;
                // Only show number if width allows
                el.innerHTML = `<span>${val}</span>`;
                
                // Style logic
                const heightPct = (val / maxVal) * 90; // Max 90% height
                el.style.height = `${heightPct}%`;
                el.style.width = `${barWidth}px`;
                
                // Position logic
                const leftPos = startX + idx * (barWidth + gap);
                el.style.left = `${leftPos}px`;
                el.dataset.leftPos = leftPos; // Store for easy access
                
                container.appendChild(el);
            });
            
            // Store layout info for pointers
            container.dataset.barWidth = barWidth;
            container.dataset.gap = gap;
            container.dataset.startX = startX;
        }

        function resetVisualization() {
            if(abortController) abortController.abort();
            isRunning = false;
            startBtn.disabled = false;
            initArray();
        }

        async function startVisualization() {
            if (isRunning) return;
            
            const kStr = document.getElementById('kInput').value;
            let k = parseInt(kStr);
            if (k > arrayData.length || k < 1) {
                alert(`K 必须在 1 到 ${arrayData.length} 之间`);
                return;
            }

            isRunning = true;
            abortController = new AbortController();
            const signal = abortController.signal;
            
            startBtn.disabled = true;

            const targetIndex = arrayData.length - k;
            
            statusText.innerText = `寻找第 ${k} 个最大元素 (排序后索引: ${targetIndex})`;
            highlightLine(1);
            await sleep(delayTime);

            try {
                const result = await quickSelect(0, arrayData.length - 1, targetIndex, signal);
                
                statusText.innerHTML = `找到结果: <strong>${result}</strong>`;
                statusText.style.color = "var(--greater-color)";
                highlightLine(5);
                
                const finalBlock = document.getElementById(`block-${targetIndex}`);
                if(finalBlock) finalBlock.classList.add('found');

            } catch (e) {
                if (e.message === 'Aborted') {
                    statusText.innerText = "已重置";
                } else {
                    console.error(e);
                }
            } finally {
                isRunning = false;
                startBtn.disabled = false;
            }
        }

        // --- Algorithm Implementation ---

        async function quickSelect(left, right, target, signal) {
            checkAbort(signal);
            highlightLine(6);
            
            statusText.innerText = `搜索范围: [${left}, ${right}]`;
            
            if (left === right) {
                highlightLine(7);
                return arrayData[left];
            }

            highlightLine(10);
            const pIndex = await partition(left, right, signal);
            
            // Clean up visual styles outside range
            for(let i=left; i<=right; i++) {
                if(i !== pIndex) resetBlockStyle(i);
            }

            checkAbort(signal);

            if (target === pIndex) {
                highlightLine(12);
                highlightLine(13);
                return arrayData[pIndex];
            } else if (target < pIndex) {
                highlightLine(14);
                highlightLine(15);
                // Dim out right side
                for(let i=pIndex+1; i<=right; i++) {
                   const el = document.getElementById(`block-${i}`);
                   if(el) el.style.opacity = '0.2';
                }
                return await quickSelect(left, pIndex - 1, target, signal);
            } else {
                highlightLine(16);
                highlightLine(17);
                // Dim out left side
                for(let i=left; i<pIndex; i++) {
                    const el = document.getElementById(`block-${i}`);
                    if(el) el.style.opacity = '0.2';
                }
                return await quickSelect(pIndex + 1, right, target, signal);
            }
        }

        async function partition(left, right, signal) {
            highlightLine(20);
            checkAbort(signal);

            let pivotIndex = right;
            let pivotValue = arrayData[pivotIndex];
            statusText.innerText = `基准值 (Pivot): ${pivotValue}`;
            
            const pivotBlock = document.getElementById(`block-${pivotIndex}`);
            pivotBlock.classList.add('pivot');
            
            highlightLine(21);
            highlightLine(22);
            let storeIndex = left;
            
            updatePointer('storeIndex', storeIndex, 'Store', '#ef4444');
            
            for (let i = left; i < right; i++) {
                highlightLine(24);
                checkAbort(signal);
                
                updatePointer('i', i, 'i', '#3b82f6');
                
                const currentBlock = document.getElementById(`block-${i}`);
                currentBlock.classList.add('active'); // Highlight current
                
                // Slight delay to show comparison
                await sleep(delayTime / 2);

                highlightLine(25);
                if (arrayData[i] <= pivotValue) {
                    currentBlock.classList.add('less');
                    
                    if (i !== storeIndex) {
                        highlightLine(26);
                        await swapVisual(i, storeIndex);
                    }
                    
                    highlightLine(27);
                    storeIndex++;
                    updatePointer('storeIndex', storeIndex, 'Store', '#ef4444');
                } else {
                    currentBlock.classList.add('greater');
                }
                
                currentBlock.classList.remove('active');
                // Faster inner loop
                await sleep(delayTime * 0.2); 
            }

            statusText.innerText = `分区完成: 交换 Pivot 到位置 ${storeIndex}`;
            highlightLine(30);
            
            const pI = document.getElementById('ptr-i');
            if(pI) pI.remove();

            await swapVisual(right, storeIndex);
            
            document.getElementById(`block-${storeIndex}`).classList.remove('pivot');
            document.getElementById(`block-${storeIndex}`).classList.add('found');
            
            highlightLine(31);
            return storeIndex;
        }

        // --- Visual Helpers ---

        async function swapVisual(idx1, idx2) {
            if (idx1 === idx2) return;

            const el1 = document.getElementById(`block-${idx1}`);
            const el2 = document.getElementById(`block-${idx2}`);

            const left1 = el1.style.left;
            const left2 = el2.style.left;

            // Lift animation for bars
            el1.style.transform = `translateY(-20px)`; 
            el2.style.transform = `translateY(-20px)`;
            el1.style.zIndex = 100;
            el2.style.zIndex = 100;
            
            await sleep(delayTime / 2);

            el1.style.left = left2;
            el2.style.left = left1;
            
            // Reset Y
            el1.style.transform = 'translateY(0)';
            el2.style.transform = 'translateY(0)';
            el1.style.zIndex = '';
            el2.style.zIndex = '';

            await sleep(delayTime);

            // Swap Data Array
            let temp = arrayData[idx1];
            arrayData[idx1] = arrayData[idx2];
            arrayData[idx2] = temp;

            // Swap DOM IDs so index lookup stays consistent
            const tempId = el1.id;
            el1.id = el2.id;
            el2.id = tempId;
        }

        function updatePointer(name, index, labelText, color) {
            let ptr = document.getElementById(`ptr-${name}`);
            
            // Calculate position using stored layout info
            const barWidth = parseFloat(container.dataset.barWidth);
            const gap = parseFloat(container.dataset.gap);
            const startX = parseFloat(container.dataset.startX);
            
            const leftPos = startX + index * (barWidth + gap);

            if (!ptr) {
                ptr = document.createElement('div');
                ptr.id = `ptr-${name}`;
                ptr.className = 'pointer-marker';
                ptr.style.color = color;
                
                ptr.innerHTML = `<div class="arrow">↑</div><div class="label" style="background:${color}">${labelText}</div>`;
                pointersContainer.appendChild(ptr);
            }
            
            ptr.style.left = `${leftPos}px`;
            // Center pointer relative to bar
            ptr.style.width = `${barWidth}px`; 
        }

        function clearPointers() {
            pointersContainer.innerHTML = '';
        }

        function resetBlockStyle(idx) {
            const el = document.getElementById(`block-${idx}`);
            if(el) {
                el.className = 'block';
                // keep thin class if exists
                if(parseFloat(el.style.width) < 25) el.classList.add('thin');
            }
        }

        function highlightLine(lineNum) {
            resetLines();
            const line = document.getElementById(`line-${lineNum}`);
            if(line) {
                line.classList.add('active-line');
                
                // Custom scroll logic to prevent page scrolling
                // We only scroll the #codeContainer
                const containerRect = codeContainer.getBoundingClientRect();
                const lineRect = line.getBoundingClientRect();

                // Check if line is out of view relative to container
                const relativeTop = line.offsetTop - codeContainer.offsetTop;
                const relativeBottom = relativeTop + line.offsetHeight;
                
                // Ideally center it:
                const targetScroll = relativeTop - (codeContainer.clientHeight / 2) + (line.offsetHeight / 2);
                
                codeContainer.scrollTo({
                    top: targetScroll,
                    behavior: 'smooth'
                });
            }
        }

        function resetLines() {
            document.querySelectorAll('.line').forEach(l => l.classList.remove('active-line'));
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function checkAbort(signal) {
            if (signal && signal.aborted) {
                throw new Error('Aborted');
            }
        }

    </script>
</body>
</html>